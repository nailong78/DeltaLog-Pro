<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å¥¶é¾™@ä¸‰è§’æ´²è¡ŒåŠ¨è®°å½•å¹³å°</title>
    
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* ========================================================================== */
        /* [æ ¸å¿ƒå˜é‡å®šä¹‰] iOS 26 æ¶²æ€ç»ç’ƒç³»ç»Ÿç‰©ç†å‚æ•° */
        /* ========================================================================== */
        :root {
            --ios-bg: #F2F2F7; /* åŸºç¡€åº•è‰²ï¼šæ¨¡æ‹Ÿæ¼«åå°„çš„é‡‘å±ç°ç™½ */
            --ios-card: rgba(255, 255, 255, 0.7); /* å¡ç‰‡åŸºè´¨ï¼š70%é€æ˜åº¦ï¼Œä¸ºé«˜æ–¯æ¨¡ç³Šæä¾›æŠ˜å°„ä»‹è´¨ */
            --ios-accent: #007AFF; /* è‹¹æœç”Ÿæ€æ ‡å‡†çš„ç”µå…‰è“ */
            --ios-success: #34C759; /* è¯­ä¹‰ç»¿è‰²ï¼šç¬¦åˆäººçœ¼èˆ’é€‚åº¦çš„ç¿ ç»¿ */
            --glass-blur: 40px; /* ç‰©ç†æ¨¡ç³ŠåŠå¾„ï¼šå¼ºåŠ›æ•£ç„¦æ¨¡æ‹Ÿåšç»ç’ƒåçš„æ™¯æ·± */
            --liquid-border: rgba(255, 255, 255, 0.6); /* æ¶²æ€è¾¹ç¼˜ï¼šæ¨¡æ‹Ÿæ¶²ä½“è¡¨é¢å¼ åŠ›äº§ç”Ÿçš„é«˜å…‰åå°„ */
            --font-fluid-base: clamp(14px, 2vw, 16px); /* åŠ¨æ€å­—ä½“ï¼šéšè§†å£å®½åº¦è‡ªé€‚åº” */
            --spacing-fluid: clamp(15px, 4vw, 30px); /* åŠ¨æ€å®¹å™¨é—´è·ï¼šå‘¼å¸æ„Ÿå¸ƒå±€ */
        }

        /* é¡µé¢åº•åº§ï¼šçº¿æ€§æ¸å˜æ¨¡æ‹Ÿé¡¶éƒ¨å…‰æºç…§å°„æ•ˆæœ */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "PingFang SC", sans-serif; 
            background: linear-gradient(145deg, #F2F2F7 0%, #E5E5EA 100%); 
            color: #1C1C1E; 
            padding: var(--spacing-fluid);
            padding-top: max(var(--spacing-fluid), env(safe-area-inset-top)); /* é¿å¼€åˆ˜æµ·å±/çµåŠ¨å²›å®‰å…¨åŒºåŸŸ */
            margin: 0;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased; /* æ–‡å­—æŠ—é”¯é½¿ï¼Œç¡®ä¿ Retina å±å‘ˆç°é«˜çº§æ„Ÿ */
            font-size: var(--font-fluid-base);
        }

        /* å“åº”å¼å®¹å™¨ï¼šé™åˆ¶å¤§å±å®½åº¦ï¼Œæ¨¡æ‹Ÿæ‰‹æŒè®¾å¤‡æ“ä½œæµ */
        .app-container {
            max-width: 600px;
            margin: 0 auto;
            position: relative;
        }

        /* [æ¶²æ€ç»ç’ƒå¡ç‰‡]ï¼šæ¯›ç»ç’ƒç‰¹æ•ˆæ ¸å¿ƒå®ç° */
        .card { 
            background: var(--ios-card); 
            backdrop-filter: blur(var(--glass-blur)) saturate(180%); /* é«˜æ–¯æ¨¡ç³Š + é¥±å’Œåº¦å¢ç›Šï¼Œè¿™æ˜¯æ¶²æ€ç»ç’ƒçš„çµé­‚ */
            -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(180%);
            padding: 20px; 
            border-radius: 28px; 
            margin-bottom: 20px; 
            border: 1px solid var(--liquid-border); /* è¾¹ç¼˜é«˜å…‰å¾®ä¿®è¾¹ï¼Œæ¨¡æ‹Ÿç»ç’ƒè¾¹ç¼˜æŠ˜å°„ */
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05); /* æŸ”å’Œé˜´å½±ï¼Œå®ç° Z è½´æµ®ç©ºæ•ˆæœ */
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        h2 { 
            font-weight: 700; 
            font-size: 1.3rem; 
            margin: 20px 0 12px 5px; 
            letter-spacing: -0.5px; /* è´Ÿå­—é—´è·ï¼Œå‘ˆç° iOS ç³»ç»Ÿç´§è‡´çš„æ’ç‰ˆè´¨æ„Ÿ */
        }

        /* ç»Ÿè®¡å¸ƒå±€ï¼šå·¦å³åˆ†æ å®ç°æ•°æ®èšç„¦ */
        .analytics-box { 
            display: flex; 
            align-items: center; 
            gap: 20px; 
            margin-bottom: 15px; 
        }

        /* ç¯å½¢è¿›åº¦æ¡å®¹å™¨ */
        .circular-progress { 
            width: 80px; height: 80px; 
            position: relative; 
            display: flex; align-items: center; justify-content: center; 
            flex-shrink: 0; 
        }
        
        /* ç¯å½¢ä¸­å¿ƒæ–‡å­—ï¼šç»å¯¹å®šä½å±…ä¸­ */
        .rate-text { 
            position: absolute; 
            font-weight: 700; 
            font-size: 1.1rem; 
        }
        
        .stat-stack { flex: 1; }
        .stat-mini { margin-bottom: 8px; }
        /* å‰¯æ ‡é¢˜ï¼šç°åº¦è®¾è®¡ï¼Œçªå‡ºä¸»è¦æ•°æ®å±‚çº§ */
        .stat-label { font-size: 0.7rem; color: #8E8E93; text-transform: uppercase; } 
        .stat-val { font-size: 1rem; font-weight: 700; display: block; }

        /* [è¶‹åŠ¿å›¾æ•°å€¼å±‚]ï¼šåœ¨å›¾è¡¨ä¸Šæ–¹æµ®åŠ¨çš„å³æ—¶æ•°å€¼ */
        .chart-overlay {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 10px;
            padding: 0 5px;
        }
        .current-trend-val {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--ios-accent);
            background: rgba(0, 122, 255, 0.1);
            padding: 2px 8px;
            border-radius: 6px;
        }

        /* [æ¶²æ€ç­›é€‰å™¨]ï¼šæ¨ªå‘æ»‘åŠ¨æµä½“è®¾è®¡ */
        .filter-scroll {
            display: flex; 
            overflow-x: auto; 
            gap: 12px; 
            padding: 4px 4px 20px 4px; 
            scrollbar-width: none; /* éšè— Firefox åŸç”Ÿæ»šåŠ¨æ¡ */
            /* é®ç½©æ¸å˜ï¼šæ¨¡æ‹Ÿå†…å®¹åœ¨è¾¹ç¼˜æ¶ˆå¤±çš„è§†è§‰æ„Ÿ */
            mask-image: linear-gradient(90deg, transparent 0%, black 5%, black 95%, transparent 100%);
            -webkit-mask-image: linear-gradient(90deg, transparent 0%, black 5%, black 95%, transparent 100%); 
        }
        .filter-scroll::-webkit-scrollbar { display: none; } /* éšè— Chrome æ»šåŠ¨æ¡ */

        .filter-chip {
            position: relative; 
            flex: 0 0 auto; 
            padding: 10px 20px; 
            border-radius: 30px; 
            background: rgba(255, 255, 255, 0.35); 
            backdrop-filter: blur(15px) saturate(120%);
            -webkit-backdrop-filter: blur(15px) saturate(120%);
            border: 1px solid rgba(255, 255, 255, 0.4); 
            font-size: 0.9rem; font-weight: 600; color: #636366; 
            cursor: pointer; 
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            overflow: hidden; 
        }

        /* [æµå…‰åŠ¨æ•ˆ]ï¼šåˆ©ç”¨ ::before ä¼ªå…ƒç´ åšæ–œå‘ç™½å…‰åŠ¨ç”»ï¼Œæ¨¡æ‹Ÿå…‰çº¿æ è¿‡æ¶²æ€è¡¨é¢ */
        .filter-chip::before {
            content: ''; position: absolute; top: 0; left: -150%; width: 100%; height: 100%;
            background: linear-gradient(115deg, transparent 30%, rgba(255, 255, 255, 0.8) 45%, rgba(255, 255, 255, 0.4) 50%, transparent 70%);
            transform: skewX(-20deg); pointer-events: none;
        }

        .filter-chip.active {
            background: linear-gradient(135deg, var(--ios-accent) 0%, #5AC8FA 100%); 
            color: white; 
            border-color: rgba(255, 255, 255, 0.2); 
            box-shadow: 0 10px 25px -5px rgba(0, 122, 255, 0.5); 
        }

        /* æ¿€æ´»æ€ä¸‹çš„æ‰«å…‰å¾ªç¯ï¼šäº§ç”ŸçµåŠ¨çš„ç”Ÿå‘½åŠ›æ„Ÿ */
        .filter-chip.active::before {
            animation: liquid-sheen 3s infinite ease-in-out; 
        }

        @keyframes liquid-sheen {
            0% { left: -150%; opacity: 0; }
            10% { opacity: 1; }
            40% { left: 150%; opacity: 0; } 
            100% { left: 150%; opacity: 0; } 
        }

        /* è¡¨å•æ§ä»¶ï¼šåµŒå…¥å¼æ¯›ç»ç’ƒå‡¹é™·æ„Ÿï¼Œå¢å¼ºäº¤äº’å±‚çº§ */
        select, input, textarea { 
            width: 100%; padding: 15px; margin: 6px 0; border-radius: 14px; 
            border: 1px solid rgba(0, 0, 0, 0.05); 
            background: rgba(255,255,255,0.5); 
            font-size: 1rem; outline: none; box-sizing: border-box;
            transition: background 0.3s;
        }
        select:focus, input:focus, textarea:focus { background: rgba(255,255,255,0.8); }

        button { 
            width: 100%; padding: 18px; background: var(--ios-accent); color: white; 
            font-weight: 600; border: none; border-radius: 18px; font-size: 17px; 
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; margin-top: 10px;
        }
        button:active { transform: scale(0.96); opacity: 0.9; } /* ç‰©ç†æŒ‰å‹åé¦ˆ */

        /* [è®°å½•é¡¹]ï¼šè¯­ä¹‰åŒ–åˆ†ç±» + å¤‡æ³¨åŒºåŸŸ */
        .log-item { 
            background: rgba(255,255,255,0.6); padding: 16px; border-radius: 22px; 
            margin-bottom: 12px; border-left: 6px solid #D1D1D6;
            display: flex; flex-direction: column; gap: 8px;
            transition: transform 0.2s;
        }
        .success { border-left-color: var(--ios-success); }
        .failed { border-left-color: #FF3B30; }

        .log-header { display: flex; justify-content: space-between; font-size: 0.75rem; color: #8E8E93; }
        .log-content { font-weight: 700; display: flex; justify-content: space-between; align-items: center; font-size: 1rem; }
        
        /* å¤‡æ³¨æ ·å¼ï¼šæ°”æ³¡æ„Ÿè®¾è®¡ï¼Œå¼±åŒ–éæ ¸å¿ƒä¿¡æ¯ */
        .log-notes { 
            font-size: 0.8rem; 
            color: #636366; 
            background: rgba(0,0,0,0.03); 
            padding: 8px 12px; 
            border-radius: 12px; 
            font-style: italic; 
            line-height: 1.4;
        }

        /* [åº•éƒ¨æ¶²æ€æ—‹è½¬åŠ¨ç”»]ï¼šå·¨å‹å¾„å‘æ¸å˜ä½é€Ÿè½¬åŠ¨ï¼Œäº§ç”Ÿè‰²å½©ç¼“æ…¢æµåŠ¨çš„å¹»è§‰ */
        .footer {
            margin: 40px 0 60px 0; padding: 24px; border-radius: 30px; 
            background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.5); position: relative; overflow: hidden;
        }
        .footer::before {
            content: ""; position: absolute; top: -100%; left: -100%; width: 300%; height: 300%;
            background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 60%);
            animation: liquid-rotate 20s infinite linear; z-index: -1;
        }
        @keyframes liquid-rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .footer p { margin: 0 0 12px 0; font-size: 0.78rem; color: #48484A; line-height: 1.6; text-align: justify; }
    </style>
</head>
<body>

    <div class="app-container">
        <div class="header-row">
            <h2>ğŸ“Š è¡ŒåŠ¨æ•°æ®åˆ†æ</h2>
        </div>

        <div class="card">
            <div class="analytics-box">
                <div class="circular-progress">
                    <canvas id="rateChart" width="80" height="80"></canvas>
                    <span class="rate-text" id="rate-percent">0%</span>
                </div>
                <div class="stat-stack">
                    <div class="stat-mini">
                        <span class="stat-label" id="analysis-title">æœ€ä½³æ”¶ç›Šåœ°å›¾</span>
                        <span id="best-map" class="stat-val">åˆ†æä¸­...</span>
                    </div>
                    <div class="stat-mini">
                        <span class="stat-label">å†å²æ€»æ”¶ç›Š</span>
                        <span id="total-loot" class="stat-val" style="color: var(--ios-accent);">0</span>
                    </div>
                </div>
            </div>

            <div class="chart-overlay">
                <span class="stat-label">è¿‘æœŸæ”¶ç›Šæ³¢åŠ¨ (è¿‘10åœº)</span>
                <span id="trend-indicator" class="current-trend-val">ï¿¥0</span>
            </div>
            
            <div style="height: 100px; width: 100%;">
                <canvas id="lineChart"></canvas>
            </div>
        </div>

        <div class="filter-scroll" id="map-filters">
            <div class="filter-chip active" onclick="filterData('å…¨éƒ¨')">å…¨éƒ¨åŒºåŸŸ</div>
            <div class="filter-chip" onclick="filterData('é›¶å·å¤§å')">é›¶å·å¤§å</div>
            <div class="filter-chip" onclick="filterData('é•¿å¼“æºªè°·')">é•¿å¼“æºªè°·</div>
            <div class="filter-chip" onclick="filterData('å·´å…‹ä»€')">å·´å…‹ä»€</div>
            <div class="filter-chip" onclick="filterData('èˆªå¤©åŸºåœ°')">èˆªå¤©åŸºåœ°</div>
            <div class="filter-chip" onclick="filterData('æ½®æ±ç›‘ç‹±')">æ½®æ±ç›‘ç‹±</div>
            <div class="filter-chip" onclick="filterData('æ ¸ç”µç«™')">æ ¸ç”µç«™</div>
        </div>

        <h2>ğŸ”« æ–°å¢è¡ŒåŠ¨è®°å½•</h2>
        <div class="card">
            <select id="operator">
                <option value="çº¢ç‹¼">çº¢ç‹¼</option><option value="å¨é¾™">å¨é¾™</option><option value="æ— å">æ— å</option>
                <option value="ç–¾é£">ç–¾é£</option><option value="èœ‚åŒ»">èœ‚åŒ»</option><option value="ä½å¨…">ä½å¨…</option>
                <option value="è¶">è¶</option><option value="ç‰§ç¾Šäºº">ç‰§ç¾Šäºº</option><option value="ä¹Œé²é²">ä¹Œé²é²</option>
                <option value="æ·±è“">æ·±è“</option><option value="æ¯”ç‰¹">æ¯”ç‰¹</option><option value="éœ²å¨œ">éœ²å¨œ</option>
                <option value="éª‡çˆª">éª‡çˆª</option><option value="é“¶ç¿¼">é“¶ç¿¼</option>
            </select>
            <select id="mission_name">
                <option value="æœºå¯†-é›¶å·å¤§å">æœºå¯†-é›¶å·å¤§å</option><option value="æ™®é€š-é›¶å·å¤§å">æ™®é€š-é›¶å·å¤§å</option>
                <option value="æœºå¯†-é•¿å¼“æºªè°·">æœºå¯†-é•¿å¼“æºªè°·</option><option value="æ™®é€š-é•¿å¼“æºªè°·">æ™®é€š-é•¿å¼“æºªè°·</option>
                <option value="æœºå¯†-å·´å…‹ä»€">æœºå¯†-å·´å…‹ä»€</option><option value="ç»å¯†-å·´å…‹ä»€">ç»å¯†-å·´å…‹ä»€</option>
                <option value="æœºå¯†-èˆªå¤©åŸºåœ°">æœºå¯†-èˆªå¤©åŸºåœ°</option><option value="ç»å¯†-èˆªå¤©åŸºåœ°">ç»å¯†-èˆªå¤©åŸºåœ°</option>
                <option value="é€‚åº”-æ½®æ±ç›‘ç‹±">é€‚åº”-æ½®æ±ç›‘ç‹±</option><option value="ç»å¯†-æ½®æ±ç›‘ç‹±">ç»å¯†-æ½®æ±ç›‘ç‹±</option>
                <option value="æ ¸ç”µç«™">æ ¸ç”µç«™</option>
            </select>
            <select id="result">
                <option value="æ’¤ç¦»æˆåŠŸ">âœ… æ’¤ç¦»æˆåŠŸ</option>
                <option value="æ’¤ç¦»å¤±è´¥">âŒ æ’¤ç¦»å¤±è´¥</option>
            </select>
            <input type="number" id="loot_value" placeholder="æ”¶ç›Šä»·å€¼ (æ•°å­—)" inputmode="numeric">
            <textarea id="notes" placeholder="æ·»åŠ å¤‡æ³¨ (å¦‚ï¼šå‡ºçº¢äº†ã€è¢«è€å…­è¹²äº†)..." rows="2"></textarea>
            <button onclick="saveData()" id="btn">ä¸Šä¼ äº‘ç«¯å­˜æ¡£</button>
        </div>

        <div id="logs-container"></div>

        <div class="footer">
            <div style="text-align: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid rgba(0,0,0,0.05);">
                <span style="background: var(--ios-accent); color: #fff; padding: 2px 8px; border-radius: 8px; font-size: 0.7rem; font-weight: 600;">PRO</span>
                <strong>@å¥¶é¾™</strong> <span style="color: #8E8E93; font-size: 0.7rem;">TG: @NL78991</span>
            </div>
            <p><strong>ä¸¥æ­£å£°æ˜ï¼š</strong>æœ¬é¡¹ç›®ä»…ä½œä¸ºã€Šä¸‰è§’æ´²è¡ŒåŠ¨ã€‹æ¸¸æˆç©å®¶ä¸ªäººè¡ŒåŠ¨è®°å½•ä¸æ”¶ç›Šç»Ÿè®¡å·¥å…·ä½¿ç”¨ï¼Œä¸æä¾›ä»»ä½•å½¢å¼çš„æ¸¸æˆå¤–æŒ‚æˆ–ç ´åå…¬å¹³æ€§çš„åŠŸèƒ½ã€‚</p>
            <p>å¼€å‘è€…ä¸å¯¹å› ä¸ªäººæ“ä½œä¸å½“ã€ç½‘ç»œæ³¢åŠ¨å¯¼è‡´çš„æ•°æ®ä¸¢å¤±æˆ–æ¸¸æˆè´¦å·é£é™©æ‰¿æ‹…è´£ä»»ã€‚</p>
        </div>
    </div>

    <script>
        /* ========================================================================== */
        /* æ•°æ®é€»è¾‘å±‚ - è¿æ¥ Supabase å®æ—¶äº‘ç«¯ */
        /* ========================================================================== */
        const SUPABASE_URL = 'https://clndcqhovsuoejehtjto.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_FuZRDl8aGeLeGrMholXimA_GsBwhYwm'; 
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let allLogs = [];
        let lineChart, rateChart;

        window.onload = fetchLogs;

        // [æ ¸å¿ƒé€»è¾‘] ä»äº‘ç«¯è·å–å…¨é‡æ•°æ®ï¼šæŒ‰æ—¶é—´å€’åºæ’åˆ—
        async function fetchLogs() {
            try {
                const { data, error } = await supabaseClient.from('delta_logs').select('*').order('created_at', { ascending: false });
                if (error) throw error;
                allLogs = data;
                filterData('å…¨éƒ¨'); // åˆå§‹åŠ è½½å…¨éƒ¨
            } catch (err) { console.error("è¯»å–å¤±è´¥:", err); }
        }

        // [å®è§‚åˆ†æ] è®¡ç®—å½“å‰æ•°æ®é›†ä¸­æ€»æ”¶ç›Šæœ€é«˜åœ°å›¾
        function getBestMapName() {
            const mapStats = {};
            allLogs.forEach(log => {
                const mapBase = log.mission_name.split('-')[1] || log.mission_name;
                mapStats[mapBase] = (mapStats[mapBase] || 0) + (parseInt(log.loot_value) || 0);
            });
            const best = Object.entries(mapStats).sort((a,b) => b[1] - a[1])[0];
            return best ? best[0] : 'æ— æ•°æ®';
        }

        // [ç­›é€‰å¼•æ“] æ ¸å¿ƒæ•°æ®åˆ†æµä¸å›¾è¡¨é‡ç»˜
        function filterData(mapName) {
            // UI äº¤äº’ï¼šé«˜äº®é€‰ä¸­çš„ç­›é€‰ç‰‡
            document.querySelectorAll('.filter-chip').forEach(c => c.classList.toggle('active', c.innerText.includes(mapName)));
            
            const titleEl = document.getElementById('analysis-title');
            const valEl = document.getElementById('best-map');

            if (mapName === 'å…¨éƒ¨') {
                titleEl.innerText = "æœ€ä½³æ”¶ç›Šåœ°å›¾";
                valEl.innerText = getBestMapName();
            } else {
                titleEl.innerText = "å½“å‰åˆ†æåŒºåŸŸ";
                valEl.innerText = mapName;
            }

            // æ•°æ®è¿‡æ»¤ï¼šæ¨¡ç³ŠåŒ¹é…åœ°å›¾åç§°
            const filtered = mapName === 'å…¨éƒ¨' ? allLogs : allLogs.filter(l => l.mission_name.includes(mapName));
            
            // è®¡ç®—å½“å‰è§†å›¾æ€»æ”¶ç›Š
            const total = filtered.reduce((sum, item) => sum + (parseInt(item.loot_value) || 0), 0);
            document.getElementById('total-loot').innerText = total.toLocaleString();
            
            // è®¡ç®—æ’¤ç¦»æˆåŠŸç‡
            const wins = filtered.filter(l => l.result === 'æ’¤ç¦»æˆåŠŸ').length;
            const rate = filtered.length ? Math.round((wins / filtered.length) * 100) : 0;
            document.getElementById('rate-percent').innerText = rate + '%';
            
            // å‡†å¤‡è¶‹åŠ¿å›¾æ•°æ®ï¼šå–æœ€è¿‘10åœºè®°å½•
            const recentLogs = filtered.slice(0, 10).reverse();
            const chartData = recentLogs.map(l => l.loot_value);
            
            // æ›´æ–°è¶‹åŠ¿å›¾ä¸Šæ–¹çš„å³æ—¶æ”¶ç›Šå€¼ï¼ˆå–æœ€åä¸€åœºçš„å€¼ï¼‰
            const latestVal = chartData.length > 0 ? chartData[chartData.length - 1] : 0;
            document.getElementById('trend-indicator').innerText = 'ï¿¥' + parseInt(latestVal).toLocaleString();
            
            updateCharts(chartData, rate);
            renderLogs(filtered);
        }

        // [æ—¥å¿—æ¸²æŸ“] ç”Ÿæˆ HTML åˆ—è¡¨ï¼ŒåŒ…å«å¤‡æ³¨å±•ç¤ºé€»è¾‘
        function renderLogs(data) {
            const container = document.getElementById('logs-container');
            container.innerHTML = data.map(item => `
                <div class="log-item ${item.result === 'æ’¤ç¦»æˆåŠŸ' ? 'success' : 'failed'}">
                    <div class="log-header">
                        <span>${item.operator || 'æœªçŸ¥å¹²å‘˜'} Â· ${item.mission_name}</span>
                        <span>${new Date(item.created_at).toLocaleDateString()}</span>
                    </div>
                    <div class="log-content">
                        <span>${item.result}</span>
                        <span>ğŸ’°${parseInt(item.loot_value).toLocaleString()}</span>
                    </div>
                    ${item.notes ? `<div class="log-notes">ğŸ“ ${item.notes}</div>` : ''}
                </div>
            `).join('');
        }

        /* ========================================================================== */
        /* å›¾è¡¨å¼•æ“ - Chart.js å“åº”å¼é…ç½® */
        /* ========================================================================== */
        function updateCharts(lineData, rate) {
            // [ç¯å½¢å›¾] é‡‡ç”¨æç®€ç©ºå¿ƒè®¾è®¡ï¼Œæ¨¡æ‹Ÿè‹¹æœå¥åº·é—­ç¯
            if(rateChart) rateChart.destroy();
            rateChart = new Chart(document.getElementById('rateChart'), {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [rate, 100 - rate],
                        backgroundColor: ['#34C759', 'rgba(0,0,0,0.05)'], 
                        borderWidth: 0, cutout: '80%'
                    }]
                },
                options: { plugins: { legend: { display: false } }, events: [], maintainAspectRatio: true }
            });

            // [è¶‹åŠ¿å›¾] é‡‡ç”¨è´å¡å°”æ›²çº¿ï¼Œæ¨¡æ‹Ÿæ¶²æ€æµåŠ¨æ„Ÿ
            const lCtx = document.getElementById('lineChart').getContext('2d');
            if(lineChart) lineChart.destroy();
            lineChart = new Chart(lCtx, {
                type: 'line',
                data: {
                    labels: lineData.map((_,i) => i),
                    datasets: [{
                        data: lineData, 
                        borderColor: '#007AFF', 
                        borderWidth: 2, 
                        tension: 0.4, // æ›²çº¿å¼§åº¦æ§åˆ¶
                        fill: true, 
                        pointRadius: 4, // å¼€å¯åœ†ç‚¹ï¼Œæ–¹ä¾¿åœ¨æ›²çº¿ä¸­è¯†åˆ«åœºæ¬¡
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#007AFF',
                        pointBorderWidth: 2
                    }]
                },
                options: { 
                    plugins: { legend: { display: false } },
                    scales: { 
                        x: { display: false }, 
                        y: { display: false, beginAtZero: true } // éšè—åæ ‡è½´ä¿æŒçº¯å‡€
                    }, 
                    maintainAspectRatio: false, 
                    responsive: true 
                }
            });
            // çº¿æ€§æ¸å˜å¡«å……ï¼šæ¨¡æ‹Ÿæ¶²ä½“åœ¨å®¹å™¨åº•éƒ¨çš„ç§¯èš
            const g = lCtx.createLinearGradient(0,0,0,100);
            g.addColorStop(0, 'rgba(0,122,255,0.15)'); g.addColorStop(1, 'rgba(0,122,255,0)');
            lineChart.data.datasets[0].backgroundColor = g;
            lineChart.update();
        }

        // [æ•°æ®ä¸Šä¼ ] æäº¤è‡³ Supabase
        async function saveData() {
            const val = document.getElementById('loot_value').value;
            if(!val) return alert("è¯·è¾“å…¥æ”¶ç›Šæ•°å€¼");
            if(!confirm("ç¡®å®šæäº¤æœ¬æ¬¡è¡ŒåŠ¨è®°å½•å—ï¼Ÿ")) return;

            const btn = document.getElementById('btn');
            btn.disabled = true; btn.innerText = "åŒæ­¥è‡³äº‘ç«¯...";
            try {
                const { error } = await supabaseClient.from('delta_logs').insert([{
                    mission_name: document.getElementById('mission_name').value,
                    operator: document.getElementById('operator').value,
                    result: document.getElementById('result').value,
                    loot_value: parseInt(val),
                    notes: document.getElementById('notes').value
                }]);
                if (error) throw error;
                
                // é‡ç½®è¡¨å•
                document.getElementById('loot_value').value = '';
                document.getElementById('notes').value = '';
                await fetchLogs(); // é‡æ–°æ‹‰å–å¹¶è§¦å‘ç­›é€‰å¼•æ“é‡ç»˜
            } catch (err) { alert("äº‘ç«¯æäº¤å¤±è´¥: " + err.message); }
            finally { btn.disabled = false; btn.innerText = "ä¸Šä¼ äº‘ç«¯å­˜æ¡£"; }
        }
    </script>
</body>
</html>
